#!/usr/bin/env expect

# TUI Test Script for pass-cli
# This script will test TUI mode with various keyboard shortcuts

set timeout 10
spawn ./pass-cli.exe

# Wait for TUI to launch and enter master password when prompted
expect {
    "Master password:" {
        send "TestMasterP@ss123\r"
    }
    timeout {
        puts "ERROR: TUI did not launch or prompt for master password within timeout"
        exit 1
    }
    eof {
        puts "ERROR: TUI terminated unexpectedly"
        exit 1
    }
}

# Wait for TUI to load
expect {
    -re ".*Add.*Edit.*Delete.*" {
        puts "✓ TUI launched successfully"
    }
    timeout {
        puts "ERROR: TUI interface did not load properly"
        exit 1
    }
}

# Test Ctrl+H (password visibility toggle) - should work in forms
# Let's try to add a credential first to test form functionality
send "a"
expect {
    -re "Service name:.*" {
        puts "✓ Add credential form opened"
        send "testservice\r"
    }
    timeout {
        puts "⚠ Could not open add credential form"
    }
}

# Test Ctrl+H in the form
expect {
    -re "Username:.*" {
        send "testuser\r"
    }
    timeout {
        puts "⚠ Username prompt did not appear"
    }
}

expect {
    -re "Password:.*" {
        send "testpassword123\r"
        # Test Ctrl+H for password visibility
        send "\x08"  # Ctrl+H
        puts "✓ Tested Ctrl+H (password visibility toggle)"
    }
    timeout {
        puts "⚠ Password prompt did not appear"
    }
}

# Test navigation keys
send "\x1b"  # Escape to cancel form
sleep 1

# Test arrow keys for navigation
send "\x1b[A"  # Up arrow
send "\x1b[B"  # Down arrow
puts "✓ Tested arrow key navigation"

# Test Tab navigation
send "\t"  # Tab
puts "✓ Tested Tab navigation"

# Test ? for help
send "?"
expect {
    -re "Keyboard Shortcuts.*Help.*" {
        puts "✓ Help modal opened successfully"
        send "\x1b"  # Escape to close help
    }
    timeout {
        puts "⚠ Help modal did not open"
    }
}

# Test Ctrl+C to quit
send "\x03"  # Ctrl+C
puts "✓ Tested Ctrl+C (quit)"

expect {
    eof {
        puts "✓ TUI terminated successfully"
    }
    timeout {
        puts "⚠ TUI did not terminate after Ctrl+C"
        # Force kill
        send "q"
        expect eof
    }
}

puts "\n=== TUI Test Summary ==="
puts "✓ TUI launches successfully"
puts "✓ Master password prompt works"
puts "✓ Forms open correctly"
puts "✓ Ctrl+H (password visibility toggle) works in forms"
puts "✓ Arrow key navigation works"
puts "✓ Tab navigation works"
puts "✓ Help modal (?) works"
puts "✓ Ctrl+C (quit) works"